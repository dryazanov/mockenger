<mkngr-navbar></mkngr-navbar>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3" ng-controller="GroupListController">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="pull-right">
                        <a type="button" href="/#/" class="btn btn-sm btn-primary" >
                            <span class="glyphicon glyphicon-list"></span>
                        </a>
                    </div>
                    <h5>{{currentProject.name}} <span class="label label-success">{{currentProject.type}}</span></h5>
                </div>
                <div class="list-group" ng-if="groupListService.getData().length == 0">
                    <div class="list-group-item"><h4>No groups here</h4></div>
                </div>
                <div class="list-group" ng-if="groupListService.getData().length > 0">
                    <a href class="list-group-item" ng-class="{active: isActive(group)}" ng-repeat="group in groupListService.getData() track by $index">
                        <div class="pull-right">
                            <button class="btn-primary btn-xs" ng-click="editGroup(group)">
                                <span class="glyphicon glyphicon-cog"></span>
                            </button>
                            <button class="btn-primary btn-xs" ng-really-click="deleteGroup($index, group)"
                                    ng-really-message="Do you really want to delete group '{{project.name}}' with all its mocks?">
                                <span class="glyphicon glyphicon-trash"></span>
                            </button>
                        </div>
                        <div ng-click="loadGroupRequests(group)">
                            {{group.name}}
                            &nbsp;
                            <span ng-show="!group.recording" class="label label-primary">Not recording</span>
                            <span ng-show="group.recording" class="label label-danger">Recording</span>
                        </div>
                    </a>
                </div>
                <div class="panel-footer">
                    <div class="pull-right">
                        <button type="button" class="btn btn-warning btn-sm" ng-click="createGroup()">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                            Create group
                        </button>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>

        <div class="col-md-9" ng-controller="RequestListController">
            <div ng-if="requestListService.getData() == null" class="alert" role="alert">
                Please select a group
            </div>

            <div ng-if="requestListService.getData() != null &&  !requestListService.getCurrent()" class="panel panel-default">
                <div class="panel-heading">
                    <form class="form-inline">
                        <div class="form-group">
                            <input type="search" ng-model="requestListService.filters.search.query" class="form-control" id="searchRequests" placeholder="Search">
                        </div>
                        <div class="form-group">
                            <select ng-model="requestListService.filters.order" id="orderRequests" class="form-control">
                                <optgroup label="Order by">
                                    <option value="creationDate">Date</option>
                                    <option value="name">Name</option>
                                    <option value="method">Method</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="pull-right">
                            <button type="button" class="btn btn-sm btn-warning" ng-click="createRequest()">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                Create request
                            </button>
                        </div>
                    </form>
                </div>

                <div class="panel-body">
                    <div ng-if="pageCount() <= 0">
                        <h4>No results found</h4>
                        <br/>
                        <h5>Please use <b>Create request</b> button to add new request</h5>
                        <h5>Alternatively, you can switch on <b>Recording</b> on the group level and send your requests to <b>{{groupListService.getUrlForNewRequests()}}</b></h5>
                    </div>
                    <table class="table table-striped table-hover" ng-if="pageCount() > 0">
                        <thead>
                            <tr>
                                <th>Creation&nbsp;date</th>
                                <th>Name</th>
                                <th>Method</th>
                                <th>Path</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="request in requestListService.getData()
                                    | filter:requestListService.getSearchQuery()
                                    | orderBy:requestListService.getListOrder()
                                    | offset:getOffset()
                                    | limitTo:requestListService.getLimit() track by $index">

                                <td class="col-md-2"><a href ng-click="selectRequest($index, request)">{{request.creationDate | date:'dd-MM-yyyy HH:mm:ss'}}</a></td>
                                <td class="col-md-2">{{request.name}}</td>
                                <td class="col-md-2">{{request.method}}</td>
                                <td class="col-md-8">@{{request.path.value}}</td>
                                <td class="col-md-1">
                                    <button class="btn-primary btn-xs" ng-really-click="deleteRequest(request)"
                                            ng-really-message="Do you really want to delete this request?">
                                        <span class="glyphicon glyphicon-trash"></span>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="panel-footer" ng-show="pageCount() > 1">
                    <ul class="pagination pull-right">
                        <li ng-class="{disabled: isPrevPageDisabled()}">
                            <a href ng-click="prevPage()" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        <li ng-repeat="n in range()" ng-class="{active: isActive(n)}">
                            <a href ng-click="requestListService.setCurrentPage(n)">{{n+1}}</a>
                        </li>

                        <li ng-class="{disabled: isNextPageDisabled()}">
                            <a href ng-click="nextPage()" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
            </div>

            <div class="row" ng-if="requestListService.getCurrent()">
                <div class="col-md-12" ng-controller="RequestController">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="pull-right">
                                        <button class="btn btn-sm btn-primary" ng-click="requestListService.setCurrent(null)">
                                            <span class="glyphicon glyphicon-list"></span>
                                        </button>
                                        <button class="btn btn-sm btn-primary" ng-class="{disabled: isPrevRequestDisabled()}" ng-click="prevRequest()">
                                            <span class="glyphicon glyphicon-chevron-left"></span>
                                        </button>
                                        <button class="btn btn-sm btn-primary" ng-class="{disabled: isNextRequestDisabled()}" ng-click="nextRequest()">
                                            <span class="glyphicon glyphicon-chevron-right"></span>
                                        </button>
                                    </div>
                                    <h5>{{requestListService.getCurrent().name}}</h5>
                                </div>
                            </div>
                        </div>
                        <div class="panel-body">
                            <form name="mockRequestForm" novalidate>
                                <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <tabset>
                                            <tab heading="#">
                                                <br/>
                                                <div class="form-group" ng-class="hasError(mockRequestForm.requestName)">
                                                    <label for="url">Name</label>
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <input type="text" name="requestName" id="requestName"
                                                                       ng-model="requestListService.getCurrent().name"
                                                                       class="form-control" required
                                                                       aria-describedby="sizing-addon1">
                                                                <p ng-show="mockRequestForm.requestName.$invalid && !mockRequestForm.requestName.$pristine"
                                                                   class="help-block">Name is required.</p>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                <div class="form-group">
                                                    <table class="table">
                                                        <tr>
                                                            <td class="col-lg-2">
                                                                <label>Creation date</label>
                                                            </td>
                                                            <td>
                                                                {{requestListService.getCurrent().creationDate | date:'dd-MM-yyyy HH:mm:ss'}}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="col-lg-2">
                                                                <label>Request unique code</label>
                                                            </td>
                                                            <td>
                                                                {{requestListService.getCurrent().uniqueCode}}
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                            <tab heading="Path">
                                                <br/>
                                                <div class="form-group">
                                                    <label for="url">Path</label>
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <div class="input-group">
                                                                    <div class="input-group-btn">
                                                                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                                                                aria-haspopup="true" aria-expanded="false">{{requestListService.getCurrent().method}} <span class="caret"></span></button>
                                                                        <ul class="dropdown-menu">
                                                                            <li ng-repeat="method in requestMethods">
                                                                                <a href ng-click="selectMethod(method)">{{method}}</a>
                                                                            </li>
                                                                        </ul>
                                                                    </div>
                                                                    <input type="text" name="url" id="url" ng-model="requestListService.getCurrent().path.value"
                                                                           class="form-control" aria-describedby="sizing-addon1" placeholder="Path">
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group">
                                                    <label>Transformers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="pathTransformer in requestListService.getCurrent().path.transformers">
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="pathTransformer.pattern" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Pattern, regular expressions allowed">
                                                            </td>
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="pathTransformer.replacement" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Replacement">
                                                            </td>
                                                            <td class="col-lg-1">
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteTransformer($index, requestListService.getCurrent().path.transformers)"
                                                                        ng-really-message="Do you really want to delete this transformer?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="4">
                                                                <a href ng-click="addPathTransformer()">Add transformer</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                            <tab heading="Parameters">
                                                <br/>
                                                <div class="form-group">
                                                    <label for="url">Parameters</label>
                                                    <table class="table">
                                                        <tr ng-repeat="parameter in requestListService.getCurrent().parameters.values track by $index">
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="parameter.key" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Name">
                                                            </td>
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="parameter.value" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Value">
                                                            </td>
                                                            <td>
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteParameter($index)"
                                                                        ng-really-message="Do you really want to delete this parameter?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <a href ng-click="addParameter()">Add parameter</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group">
                                                    <label>Transformers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="paramTransformer in requestListService.getCurrent().parameters.transformers">
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="paramTransformer.key" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Key">
                                                            </td>
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="paramTransformer.pattern" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Pattern">
                                                            </td>
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="paramTransformer.replacement" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Replacement">
                                                            </td>
                                                            <td class="col-lg-1">
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteTransformer($index, requestListService.getCurrent().parameters.transformers)"
                                                                        ng-really-message="Do you really want to delete this transformer?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="4">
                                                                <a href ng-click="addParamTransformer()">Add transformer</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                            <tab heading="Headers">
                                                <br/>
                                                <div class="form-group">
                                                    <label for="url">Headers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="requestHeader in requestListService.getCurrent().headers.values track by $index">
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="requestHeader.key"
                                                                       typeahead="header for header in headerList | filter:$viewValue | limitTo:10"
                                                                       class="form-control" aria-describedby="sizing-addon1" placeholder="Header name">
                                                            </td>
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="requestHeader.value" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Value">
                                                            </td>
                                                            <td>
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteHeader($index, requestListService.getCurrent().headers.values)"
                                                                        ng-really-message="Do you really want to delete this header?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <a href ng-click="addRequestHeader()">Add header</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group">
                                                    <label>Transformers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="headerTransformer in requestListService.getCurrent().headers.transformers">
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="headerTransformer.key" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Key">
                                                            </td>
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="headerTransformer.pattern" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Pattern">
                                                            </td>
                                                            <td class="col-lg-4">
                                                                <input type="text" ng-model="headerTransformer.replacement" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Replacement">
                                                            </td>
                                                            <td class="col-lg-1">
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteTransformer($index, requestListService.getCurrent().headers.transformers)"
                                                                        ng-really-message="Do you really want to delete this transformer?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="4">
                                                                <a href ng-click="addHeaderTransformer()">Add transformer</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                            <tab heading="Request" disable="isRequestTabDisabled()">
                                                <br/>
                                                <div class="form-group">
                                                    <label>Transformers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="bodyTransformer in requestListService.getCurrent().body.transformers">
                                                            <td class="col-lg-2">
                                                                <select ng-model="bodyTransformer.type" required class="form-control">
                                                                    <option ng-repeat="typeName in bodyTransformerTypes">{{typeName}}</option>
                                                                </select>
                                                            </td>
                                                            <td class="col-lg-5">
                                                                <input type="text" ng-model="bodyTransformer.pattern" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Pattern">
                                                            </td>
                                                            <td class="col-lg-5">
                                                                <input type="text" ng-model="bodyTransformer.replacement" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Replacement">
                                                            </td>
                                                            <td>
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteTransformer($index, requestListService.getCurrent().body.transformers)"
                                                                        ng-really-message="Do you really want to delete this transformer?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="4">
                                                                <a href ng-click="addRequestBodyTransformer()">Add transformer</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group">
                                                    <label for="requestBody">Request body</label>
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <textarea ng-model="requestListService.getCurrent().body.value" name="requestBody" id="requestBody"
                                                                          class="form-control" aria-describedby="sizing-addon1" rows="10"></textarea>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                            <tab heading="Response">
                                                <br/>
                                                <div class="form-group">
                                                    <label for="url">Headers</label>
                                                    <table class="table">
                                                        <tr ng-repeat="responseHeader in requestListService.getCurrent().mockResponse.headers track by $index">
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="responseHeader.key"
                                                                       typeahead="header for header in headerList | filter:$viewValue | limitTo:10"
                                                                       class="form-control" aria-describedby="sizing-addon1" placeholder="Header name">
                                                            </td>
                                                            <td class="col-lg-6">
                                                                <input type="text" ng-model="responseHeader.value" class="form-control"
                                                                       aria-describedby="sizing-addon1" placeholder="Value">
                                                            </td>
                                                            <td>
                                                                <button class="btn-danger btn-sm" ng-really-click="deleteHeader($index, requestListService.getCurrent().mockResponse.headers)"
                                                                        ng-really-message="Do you really want to delete this header?">
                                                                    <span class="glyphicon glyphicon-trash"></span>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <a href ng-click="addResponseHeader()">Add header</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group" ng-class="hasError(mockRequestForm.httpStatus)">
                                                    <label for="httpStatus">HTTP status code</label>
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <!--<div class="input-group-btn">
                                                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                                                            aria-haspopup="true" aria-expanded="false">{{requestListService.getCurrent().method}} <span class="caret"></span></button>
                                                                    <ul class="dropdown-menu">
                                                                        <li ng-repeat="method in requestMethods">
                                                                            <a href ng-click="selectMethod(method)">{{method}}</a>
                                                                        </li>
                                                                    </ul>
                                                                </div>-->
                                                                <input type="text" name="httpStatus" id="httpStatus" class="form-control"
                                                                       ng-model="requestListService.getCurrent().mockResponse.httpStatus"
                                                                       aria-describedby="sizing-addon1" ng-pattern="/^[0-9]{3}$/" required>
                                                                <div ng-show="mockRequestForm.httpStatus.$invalid && !mockRequestForm.httpStatus.$pristine">
                                                                    <p ng-show="mockRequestForm.httpStatus.$error.required" class="help-block">HTTP status code is required</p>
                                                                    <p ng-show="mockRequestForm.httpStatus.$error.pattern" class="help-block">Must be 3 digits long</p>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>

                                                <div class="form-group">
                                                    <label for="responseBody">Response body</label>
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <textarea ng-model="requestListService.getCurrent().mockResponse.body" name="responseBody" id="responseBody"
                                                                          class="form-control" aria-describedby="sizing-addon1" rows="10"></textarea>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </tab>
                                        </tabset>
                                    </div>
                                </div>
                            </div>
                            </form>
                        </div>
                        <div class="panel-footer">
                            <div class="pull-right">
                                <button type="button" class="btn btn-danger" data-dismiss="modal" ng-click="requestListService.setCurrent(null)">Cancel</button>
                                <button type="button" class="btn btn-primary" ng-disabled="projectForm.$invalid" ng-click="saveRequest(requestListService.getCurrent())">Save</button>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Group -->
<div class="modal fade" id="groupModal" tabindex="-1" role="dialog" aria-labelledby="groupModalLabel" ng-controller="GroupController">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form name="groupForm" novalidate>
                <input type="hidden" ng-model="groupToSave.projectId">
                <input type="hidden" ng-model="groupToSave.id">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="requestModalLabel">{{groupToSave.id == null ? 'Create group' : 'Edit group'}}</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)" dismiss-on-timeout="true">{{alert.msg}}</alert>
                    </div>
                    <div class="form-group" ng-if="urlToSendRequests != null">
                        <label>URL for requests</label>
                        <pre>{{urlToSendRequests}}</pre>
                    </div>
                    <div class="form-group" ng-class="hasError(groupForm.name)">
                        <label for="name">Name</label>
                        <input type="text" name="name" id="name" ng-model="groupToSave.name" class="form-control" required>
                        <p ng-show="groupForm.name.$invalid && !groupForm.name.$pristine" class="help-block">Group name is required</p>
                    </div>
                    <div class="form-group">
                        <label for="recording">Record incoming requests</label>
                        <div class="form-group">
                            <div class="btn-group" id="recording">
                                <label class="btn btn-primary" ng-model="groupToSave.recording" btn-radio="true">Yes</label>
                                <label class="btn btn-primary" ng-model="groupToSave.recording" btn-radio="false">&nbsp;No&nbsp;</label>
                            </div>
                        </div>
                    </div>
                    <hr/>
                    <div class="form-group">
                        <label for="recording">Forward incoming requests</label>
                        <div class="form-group">
                            <div class="btn-group" id="forwarding">
                                <label class="btn btn-primary" ng-model="groupToSave.forwarding" btn-radio="true">Yes</label>
                                <label class="btn btn-primary" ng-model="groupToSave.forwarding" btn-radio="false">&nbsp;No&nbsp;</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" ng-class="hasError(groupForm.forwardTo)" ng-show="groupToSave.forwarding">
                        <label for="forwardTo">Base URL for forwarding</label>
                        <input type="text" name="forwardTo" id="forwardTo" ng-model="groupToSave.forwardTo" class="form-control" ng-required="groupToSave.forwarding">
                        <p ng-show="groupToSave.forwarding == true && (groupForm.forwardTo.$invalid && !groupForm.forwardTo.$pristine)" class="help-block">Base URL cannot be empty</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" ng-disabled="groupForm.$invalid" ng-click="saveGroup(groupToSave)">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
